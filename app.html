<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#006655">
<title>Midas Connect</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#f0f4f2; --surface:#fff; --surface2:#e8f0ed; --accent:#006655;
  --accent2:#008a70; --alight:#e0f0ec; --danger:#d63031; --warn:#e17055;
  --text:#1a2e28; --muted:#5a7a6e; --border:#c8ddd8; --r:16px;
  --fh:'Syne',sans-serif; --fb:'DM Sans',sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:var(--fb);background:var(--bg);color:var(--text);min-height:100vh}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(0,102,85,.04) 1px,transparent 1px),linear-gradient(90deg,rgba(0,102,85,.04) 1px,transparent 1px);background-size:36px 36px;pointer-events:none;z-index:0}
.app{position:relative;z-index:1;max-width:480px;margin:0 auto;padding:20px 16px 100px}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:12px 16px;box-shadow:0 2px 12px rgba(0,102,85,.08)}
.header-left{display:flex;flex-direction:column;gap:2px}
.logo-img{height:38px;object-fit:contain}
.app-name{font-family:var(--fh);font-size:10px;font-weight:700;letter-spacing:2px;color:var(--muted);text-transform:uppercase;margin-top:2px}
.badge{background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:5px 12px;font-size:11px;color:var(--muted);font-weight:500}
.badge.live{border-color:var(--accent);color:var(--accent)}
.badge.live::before{content:"‚óè ";animation:blink 1.2s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
#gps-banner{background:var(--surface);border:1px solid var(--border);border-left:3px solid var(--accent2);border-radius:var(--r);padding:12px 14px;margin-bottom:14px;display:flex;align-items:center;gap:10px;transition:all .3s}
#gps-banner.ok{border-left-color:var(--accent);background:#f0faf7}
.gps-icon{font-size:20px;flex-shrink:0}
.gps-info{flex:1}
.gps-label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:2px}
.gps-value{font-size:11px;font-weight:600;color:var(--text);word-break:break-all}
#gps-btn{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:8px 14px;font-family:var(--fb);font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap}
#gps-btn:disabled{opacity:.4;cursor:not-allowed}
.tabs{display:flex;gap:6px;margin-bottom:14px}
.tab-btn{flex:1;padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--surface2);color:var(--muted);font-family:var(--fh);font-size:12px;font-weight:700;cursor:pointer;text-transform:uppercase;letter-spacing:.5px}
.tab-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.tab-panel{display:none}
.tab-panel.active{display:block}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:18px;margin-bottom:12px;box-shadow:0 2px 10px rgba(0,102,85,.06)}
.card-title{font-family:var(--fh);font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-bottom:14px}
.field{margin-bottom:12px}
label{display:block;font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;margin-bottom:5px}
.req{color:var(--danger)}
input[type=text],input[type=tel],select{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:11px 13px;color:var(--text);font-family:var(--fb);font-size:15px;outline:none;-webkit-appearance:none;transition:border-color .2s}
input:focus,select:focus{border-color:var(--accent);background:#f5faf8}
select:disabled,input:disabled{opacity:.5}
.field-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.field-hint{font-size:10px;color:var(--muted);margin-top:4px}
.ferr{font-size:11px;color:var(--danger);margin-top:4px;display:none;font-weight:500}
.ferr.on{display:block}
.photo-zone{border:2px dashed var(--border);border-radius:var(--r);min-height:150px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;cursor:pointer;overflow:hidden;position:relative;background:var(--surface2)}
.photo-zone.has-photo{border-style:solid;border-color:var(--accent)}
.photo-zone img{width:100%;height:170px;object-fit:cover;border-radius:12px}
.photo-overlay{position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,.6);border-radius:8px;padding:4px 10px;font-size:11px;color:#fff}
.ph{display:flex;flex-direction:column;align-items:center;gap:6px;color:var(--muted);pointer-events:none}
.ph .icon{font-size:30px;opacity:.5}
.ph p{font-size:13px;font-weight:600}
.ph span{font-size:11px}
.sbtn{width:100%;padding:16px;background:var(--accent);border:none;border-radius:var(--r);color:#fff;font-family:var(--fh);font-size:16px;font-weight:700;cursor:pointer;box-shadow:0 4px 20px rgba(0,102,85,.3);margin-top:6px}
.sbtn:disabled{opacity:.5;cursor:not-allowed}
#toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--accent);color:#fff;padding:13px 22px;border-radius:30px;font-size:14px;font-weight:600;box-shadow:0 8px 30px rgba(0,0,0,.15);transition:transform .3s;white-space:nowrap;z-index:100}
#toast.show{transform:translateX(-50%) translateY(0)}
#toast.err{background:var(--danger)}
#toast.warn{background:var(--warn)}
.slabel{font-family:var(--fh);font-size:11px;text-transform:uppercase;letter-spacing:2px;color:var(--muted);margin:22px 0 10px;display:flex;align-items:center;gap:10px}
.slabel::after{content:'';flex:1;height:1px;background:var(--border)}
.logcard{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;box-shadow:0 2px 10px rgba(0,102,85,.06)}
.loghdr{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border)}
.logtitle{font-family:var(--fh);font-size:14px;font-weight:700}
.logcnt{background:var(--accent);color:#fff;font-size:11px;font-weight:800;padding:3px 9px;border-radius:20px}
.vi{padding:12px 18px;border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:flex-start}
.vi:last-child{border-bottom:none}
.vthumb{width:44px;height:44px;border-radius:8px;object-fit:cover;flex-shrink:0}
.vnothumb{width:44px;height:44px;border-radius:8px;background:var(--alight);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.vdet{flex:1;min-width:0}
.vclient{font-weight:600;font-size:14px;margin-bottom:2px}
.vmeta{font-size:11px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap}
.pill{display:inline-block;padding:2px 8px;border-radius:20px;font-size:10px;font-weight:700;text-transform:uppercase}
.p0{background:#d4f5e9;color:#006644}
.p1{background:#d4eaf5;color:#005080}
.p2{background:#fde8e8;color:#c0392b}
.p3{background:#fff3cd;color:#856404}
.p4{background:#ffe0cc;color:#8a3a00}
.p5{background:#e8d5f5;color:#5a0080}
.expbtn{margin:0 18px 16px;width:calc(100% - 36px);padding:11px;background:transparent;border:1px solid var(--border);border-radius:10px;color:var(--muted);font-family:var(--fb);font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px}
.expbtn:hover{border-color:var(--accent);color:var(--accent)}
.emptylog{padding:28px 18px;text-align:center;color:var(--muted);font-size:13px}
#ejstatus{font-size:11px;color:var(--muted);margin-top:5px;display:none}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="header-left">
      <img src="data:image/png;base64,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" alt="Tecnolabs" class="logo-img">
      <div class="app-name">Midas Connect</div>
    </div>
    <div class="badge" id="status-badge">GPS Inactivo</div>
  </div>

  <div id="gps-banner">
    <div class="gps-icon">üìç</div>
    <div class="gps-info">
      <div class="gps-label">Ubicaci√≥n actual</div>
      <div class="gps-value" id="gps-text">Sin ubicaci√≥n ‚Äî requerida para registrar</div>
    </div>
    <button id="gps-btn" onclick="captureGPS()">Obtener GPS</button>
  </div>

  <!-- LOG PANEL -->
  <div id="logpanel" style="display:none;background:#0a0f14;color:#00e5a0;font-family:monospace;font-size:11px;padding:12px;border-radius:12px;margin-bottom:12px;max-height:200px;overflow-y:auto;word-break:break-all;white-space:pre-wrap;border:1px solid #00e5a0"></div>

  <div class="tabs">
    <button class="tab-btn active" id="tab-btn-visita" onclick="switchTab('visita')">üìã Registrar Visita</button>
    <button class="tab-btn" id="tab-btn-cliente" onclick="switchTab('cliente')">‚ûï Nuevo Cliente</button>
  </div>

  <div class="tab-panel active" id="tab-visita">
    <div class="card">
      <div class="card-title">Datos de la Visita</div>
      <div class="field">
        <label>Ejecutivo <span class="req">*</span></label>
        <select id="f-ej" onchange="onEjChange()">
          <option value="">‚Äî Cargando... ‚Äî</option>
        </select>
        <div id="ejstatus"></div>
      </div>
      <div class="field">
        <label>Cliente <span class="req">*</span></label>
        <select id="f-cl" disabled>
          <option value="">‚Äî Selecciona ejecutivo primero ‚Äî</option>
        </select>
      </div>
      <div class="field">
        <label>Resultado <span class="req">*</span></label>
        <select id="f-res" disabled>
          <option value="">‚Äî Cargando resultados... ‚Äî</option>
        </select>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Evidencia Fotogr√°fica <span class="req">*</span></div>
      <div class="photo-zone" id="photo-zone" onclick="openCamera()">
        <input type="file" accept="image/*" capture="environment" id="photo-input" onchange="handlePhoto(event)" style="display:none">
        <div class="ph"><div class="icon">üì∑</div><p>Tomar foto</p><span>Obligatoria ‚Äî solo c√°mara</span></div>
      </div>
    </div>
    <button class="sbtn" id="btn-registrar" onclick="submitVisit()">‚úì &nbsp; Registrar Visita</button>
  </div>

  <div class="tab-panel" id="tab-cliente">
    <div class="card">
      <div class="card-title">Crear Nuevo Cliente</div>
      <div class="field">
        <label>Ejecutivo asignado <span class="req">*</span></label>
        <select id="nc-ej"><option value="">‚Äî Selecciona ejecutivo ‚Äî</option></select>
      </div>
      <div class="field">
        <label>Nombre del cliente <span class="req">*</span></label>
        <input type="text" id="nc-nom" placeholder="Ej: Farmacia San Jos√©" oninput="sanTxt(this)">
        <div class="field-hint">Solo letras, n√∫meros y espacios</div>
        <div class="ferr" id="err-nom"></div>
      </div>
      <div class="field-row">
        <div class="field">
          <label>Tel√©fono <span class="req">*</span></label>
          <input type="tel" id="nc-tel" placeholder="3001234567" inputmode="numeric" oninput="sanNum(this)">
          <div class="ferr" id="err-tel"></div>
        </div>
        <div class="field">
          <label>C√©dula / NIT <span class="req">*</span></label>
          <input type="tel" id="nc-ced" placeholder="123456789" inputmode="numeric" oninput="sanNum(this)">
          <div class="ferr" id="err-ced"></div>
        </div>
      </div>
      <div class="field">
        <label>Direcci√≥n <span class="req">*</span></label>
        <input type="text" id="nc-dir" placeholder="Cra 15 No 23 45" oninput="sanDir(this)">
        <div class="field-hint">Solo letras, n√∫meros, espacios y puntos</div>
        <div class="ferr" id="err-dir"></div>
      </div>
      <div class="field-row">
        <div class="field">
          <label>Ciudad <span class="req">*</span></label>
          <input type="text" id="nc-ciu" placeholder="Bogot√°" oninput="sanTxt(this)">
          <div class="ferr" id="err-ciu"></div>
        </div>
        <div class="field">
          <label>Barrio <span class="req">*</span></label>
          <input type="text" id="nc-bar" placeholder="Chapinero" oninput="sanTxt(this)">
          <div class="ferr" id="err-bar"></div>
        </div>
      </div>
    </div>
    <button class="sbtn" id="btn-cliente" onclick="guardarCliente()">‚ûï &nbsp; Guardar Cliente</button>
  </div>

  <div class="slabel">Visitas registradas hoy</div>
  <div class="logcard">
    <div class="loghdr">
      <div class="logtitle">Historial</div>
      <div class="logcnt" id="vcnt">0</div>
    </div>
    <div id="vlist"><div class="emptylog">A√∫n no hay visitas registradas</div></div>
    <button class="expbtn" onclick="exportCSV()">‚¨á Exportar CSV</button>
  </div>
</div>

<div id="toast"></div>

<script>
var SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzKKEY60FtX9NkpsMC4Ve9k_IA51NiUeWWW1YQ8RHNXG11SIH2Ba3pk5z-26cMm6RBg/exec";

// Estado global
var gps = null;
var foto = null;
var catalogo = {};
var resultados = [];
var visitas = [];

try { visitas = JSON.parse(localStorage.getItem("mc_v") || "[]"); } catch(e) { visitas = []; }

// Inicializar
renderVisitas();
cargarCatalogo();
cargarResultados();

// ‚îÄ‚îÄ Tabs
function switchTab(t) {
  document.getElementById("tab-visita").className  = "tab-panel" + (t==="visita"  ? " active" : "");
  document.getElementById("tab-cliente").className = "tab-panel" + (t==="cliente" ? " active" : "");
  document.getElementById("tab-btn-visita").className  = "tab-btn" + (t==="visita"  ? " active" : "");
  document.getElementById("tab-btn-cliente").className = "tab-btn" + (t==="cliente" ? " active" : "");
}

// ‚îÄ‚îÄ JSONP
function jsonp(url, cb) {
  var n = "cb" + Date.now();
  var s = document.createElement("script");
  s.src = url + (url.indexOf("?") > -1 ? "&" : "?") + "callback=" + n;
  var done = false;
  window[n] = function(d) {
    if (done) return; done = true;
    delete window[n];
    if (s.parentNode) s.parentNode.removeChild(s);
    cb(null, d);
  };
  s.onerror = function() {
    if (done) return; done = true;
    delete window[n];
    if (s.parentNode) s.parentNode.removeChild(s);
    cb(new Error("network"));
  };
  document.head.appendChild(s);
}

// ‚îÄ‚îÄ Cargar cat√°logo
function cargarCatalogo() {
  var st = document.getElementById("ejstatus");
  st.style.display = "block"; st.textContent = "‚è≥ Cargando...";
  jsonp(SCRIPT_URL + "?action=catalogo", function(err, d) {
    if (err || d.error) { st.textContent = "‚ö†Ô∏è Error cargando ejecutivos"; return; }
    Object.keys(d).forEach(function(k) { d[k] = d[k].filter(function(v,i,a){return a.indexOf(v)===i;}); });
    catalogo = d;
    var opts = "<option value=''>‚Äî Selecciona tu nombre ‚Äî</option>";
    Object.keys(d).sort().forEach(function(k) { opts += "<option value='" + k + "'>" + k + "</option>"; });
    document.getElementById("f-ej").innerHTML = opts;
    document.getElementById("nc-ej").innerHTML = opts;
    st.textContent = "‚úì " + Object.keys(d).length + " ejecutivos";
    setTimeout(function(){ st.style.display="none"; }, 2000);
  });
}

// ‚îÄ‚îÄ Cargar resultados
function cargarResultados() {
  jsonp(SCRIPT_URL + "?action=resultados", function(err, d) {
    var lista = (!err && Array.isArray(d)) ? d : ["VENTA","NO HUBO CONTACTO","COBRO","PRIMER CONTACTO","SEGUNDO CONTACTO","TERCER CONTACTO"];
    resultados = lista;
    var s = document.getElementById("f-res");
    s.innerHTML = "<option value=''>‚Äî Selecciona ‚Äî</option>";
    lista.forEach(function(r){ s.innerHTML += "<option value='" + r + "'>" + r + "</option>"; });
    s.disabled = false;
  });
}

// ‚îÄ‚îÄ Ejecutivo cambia ‚Üí cargar clientes
function onEjChange() {
  var ej = document.getElementById("f-ej").value;
  var sel = document.getElementById("f-cl");
  sel.innerHTML = "<option value=''>‚Äî Selecciona cliente ‚Äî</option>";
  if (!ej || !catalogo[ej]) { sel.disabled = true; return; }
  catalogo[ej].slice().sort().forEach(function(c){
    sel.innerHTML += "<option value='" + c + "'>" + c + "</option>";
  });
  sel.disabled = false;
}

// ‚îÄ‚îÄ GPS
function captureGPS() {
  var btn = document.getElementById("gps-btn");
  btn.disabled = true; btn.textContent = "...";
  if (!navigator.geolocation) { toast("GPS no disponible", "err"); btn.disabled=false; return; }
  navigator.geolocation.getCurrentPosition(
    function(p) {
      gps = {lat: p.coords.latitude, lon: p.coords.longitude, acc: Math.round(p.coords.accuracy)};
      document.getElementById("gps-text").textContent = gps.lat.toFixed(6) + ", " + gps.lon.toFixed(6) + " (¬±" + gps.acc + "m)";
      document.getElementById("gps-banner").className = "ok";
      document.getElementById("gps-banner").setAttribute("id","gps-banner");
      document.getElementById("gps-banner").classList.add("ok");
      document.getElementById("status-badge").textContent = "GPS Activo";
      document.getElementById("status-badge").className = "badge live";
      btn.textContent = "‚úì Listo"; btn.style.background = "#008a70";
      toast("üìç Ubicaci√≥n capturada");
    },
    function(e) {
      var m = {1:"Permiso denegado",2:"No disponible",3:"Tiempo agotado"};
      toast(m[e.code]||"Error GPS","err");
      btn.disabled=false; btn.textContent="Reintentar";
    },
    {enableHighAccuracy:true, timeout:12000, maximumAge:0}
  );
}

// ‚îÄ‚îÄ Foto
function openCamera() { document.getElementById("photo-input").click(); }
function handlePhoto(e) {
  var f = e.target.files[0];
  if (!f) return;
  if (f.size > 5*1024*1024) { toast("Foto muy grande (m√°x 5MB)","err"); return; }
  var r = new FileReader();
  r.onload = function(ev) {
    foto = ev.target.result;
    var z = document.getElementById("photo-zone");
    z.className = "photo-zone has-photo";
    z.innerHTML = "<input type='file' accept='image/*' capture='environment' id='photo-input' onchange='handlePhoto(event)' style='display:none'><img src='" + foto + "' alt='' onclick='openCamera()' style='cursor:pointer;width:100%;height:170px;object-fit:cover;border-radius:12px'><div class='photo-overlay'>üì∑ Cambiar</div>";
  };
  r.readAsDataURL(f);
}

// ‚îÄ‚îÄ Sanitizaci√≥n
function sanTxt(i){ i.value=i.value.replace(/[^a-zA-Z0-9√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë√º√ú\s]/g,""); }
function sanDir(i){ i.value=i.value.replace(/[^a-zA-Z0-9√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s\.#]/g,""); }
function sanNum(i){ i.value=i.value.replace(/[^0-9]/g,""); }

// ‚îÄ‚îÄ Registrar visita
function submitVisit() {
  var ej  = document.getElementById("f-ej").value;
  var cl  = document.getElementById("f-cl").value;
  var res = document.getElementById("f-res").value;

  if (!ej)  { toast("Selecciona un ejecutivo","err"); return; }
  if (!cl)  { toast("Selecciona un cliente","err"); return; }
  if (!res) { toast("Selecciona el resultado","err"); return; }
  if (!gps) { toast("GPS obligatorio ‚Äî presiona Obtener GPS","err"); return; }
  if (!foto){ toast("La foto es obligatoria","err"); return; }

  var id      = Date.now();
  var fecha   = new Date().toLocaleString("es-CO");
  var mapsUrl = "https://maps.google.com/?q=" + gps.lat + "," + gps.lon;

  // Guardar en historial local
  visitas.unshift({id:id, fecha:fecha, ej:ej, cl:cl, res:res, mapsUrl:mapsUrl, fotoData:foto});
  try { localStorage.setItem("mc_v", JSON.stringify(visitas.slice(0,50))); } catch(e){}
  renderVisitas();

  var btn = document.getElementById("btn-registrar");
  btn.disabled = true; btn.textContent = "Enviando...";

  var p = new URLSearchParams({
    action:"nuevaVisita", id:String(id), fecha:fecha,
    ejecutivo:ej, cliente:cl, resultado:res,
    lat:String(gps.lat), lon:String(gps.lon),
    precision:String(gps.acc), mapsUrl:mapsUrl
  });

  jsonp(SCRIPT_URL + "?" + p.toString(), function(err, d) {
    btn.disabled = false;
    btn.innerHTML = "‚úì &nbsp; Registrar Visita";
    if (!err && d && d.success) {
      toast("‚úÖ Visita registrada en Sheets");
      // Subir foto aparte
      log("VISITA OK: llamando subirFoto con id=" + id + " foto=" + (foto ? "SI" : "NO"));
    if (foto) subirFoto(id, foto);
    else log("FOTO: no hay foto para subir");
    } else {
      toast("‚ö†Ô∏è " + (d && d.error ? d.error : "Error de conexi√≥n"), "err");
    }
    // Reset solo GPS y foto ‚Äî mantener ejecutivo
    resetParcial();
  });
}

// Reset solo GPS, foto y cliente ‚Äî mantiene ejecutivo seleccionado
function resetParcial() {
  gps = null; foto = null;
  // Reset GPS UI
  document.getElementById("gps-text").textContent = "Sin ubicaci√≥n ‚Äî requerida para registrar";
  document.getElementById("gps-banner").classList.remove("ok");
  document.getElementById("status-badge").textContent = "GPS Inactivo";
  document.getElementById("status-badge").className = "badge";
  var gb = document.getElementById("gps-btn");
  gb.disabled = false; gb.textContent = "Obtener GPS"; gb.style.background = "";
  // Reset foto UI
  document.getElementById("photo-zone").className = "photo-zone";
  document.getElementById("photo-zone").innerHTML = "<input type='file' accept='image/*' capture='environment' id='photo-input' onchange='handlePhoto(event)' style='display:none'><div class='ph'><div class='icon'>üì∑</div><p>Tomar foto</p><span>Obligatoria ‚Äî solo c√°mara</span></div>";
  // Reset cliente ‚Äî recargar lista del ejecutivo actual
  var ejVal = document.getElementById("f-ej").value;
  document.getElementById("f-cl").value = "";
  document.getElementById("f-res").value = "";
  if (ejVal && catalogo[ejVal]) {
    var sel = document.getElementById("f-cl");
    sel.innerHTML = "<option value=''>‚Äî Selecciona cliente ‚Äî</option>";
    catalogo[ejVal].slice().sort().forEach(function(c){
      sel.innerHTML += "<option value='" + c + "'>" + c + "</option>";
    });
    sel.disabled = false;
  }
}

// ‚îÄ‚îÄ Subir foto: comprimir y enviar base64 como texto plano
function subirFoto(visitId, b64) {
  log("FOTO: iniciando subida para visita " + visitId);
  log("FOTO: tama√±o original b64 = " + Math.round(b64.length/1024) + "KB");
  try {
    var img = new Image();
    img.onload = function() {
      var canvas = document.createElement("canvas");
      var MAX = 800;
      var ratio = Math.min(MAX/img.width, MAX/img.height, 1);
      canvas.width  = Math.round(img.width  * ratio);
      canvas.height = Math.round(img.height * ratio);
      canvas.getContext("2d").drawImage(img, 0, 0, canvas.width, canvas.height);
      var small = canvas.toDataURL("image/jpeg", 0.5);
      log("FOTO: comprimida a " + Math.round(small.length/1024) + "KB (" + canvas.width + "x" + canvas.height + ")");
      enviarFotoPost(visitId, small);
    };
    img.onerror = function() { log("FOTO ERROR: no se pudo cargar imagen"); };
    img.src = b64;
  } catch(e) { log("FOTO ERROR en subirFoto: " + e.message); }
}

function enviarFotoPost(visitId, b64) {
  try {
    var body = JSON.stringify({ action: "subirFoto", id: String(visitId), foto: b64 });
    log("FOTO: enviando POST, body size=" + Math.round(body.length/1024) + "KB");
    fetch(SCRIPT_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "text/plain" },
      body: body
    })
    .then(function() { log("FOTO: fetch completado (no-cors no devuelve respuesta)"); })
    .catch(function(err) { log("FOTO ERROR fetch: " + err.message); });
  } catch(e) { log("FOTO ERROR en enviarFotoPost: " + e.message); }
}

// ‚îÄ‚îÄ Guardar nuevo cliente
function guardarCliente() {
  document.querySelectorAll(".ferr").forEach(function(e){e.textContent="";e.className="ferr";});
  var ej  = document.getElementById("nc-ej").value.trim();
  var nom = document.getElementById("nc-nom").value.trim().toUpperCase();
  var tel = document.getElementById("nc-tel").value.trim();
  var ced = document.getElementById("nc-ced").value.trim();
  var dir = document.getElementById("nc-dir").value.trim();
  var ciu = document.getElementById("nc-ciu").value.trim().toUpperCase();
  var bar = document.getElementById("nc-bar").value.trim().toUpperCase();

  var ok = true;
  if (!ej)            { toast("Selecciona un ejecutivo","err"); ok=false; }
  if (!nom)           { setErr("err-nom","Campo requerido"); ok=false; }
  if (tel.length < 7) { setErr("err-tel","M√≠nimo 7 d√≠gitos"); ok=false; }
  if (ced.length < 6) { setErr("err-ced","M√≠nimo 6 d√≠gitos"); ok=false; }
  if (!dir)           { setErr("err-dir","Campo requerido"); ok=false; }
  if (!ciu)           { setErr("err-ciu","Campo requerido"); ok=false; }
  if (!bar)           { setErr("err-bar","Campo requerido"); ok=false; }
  if (!ok) return;

  // Validar duplicado local
  var ex = catalogo[ej] || [];
  if (ex.some(function(c){return c.toUpperCase()===nom;})) {
    setErr("err-nom","Este cliente ya existe para este ejecutivo"); return;
  }

  var btn = document.getElementById("btn-cliente");
  btn.disabled=true; btn.textContent="Guardando...";

  var p = new URLSearchParams({
    action:"nuevoCliente", ejecutivo:ej, cliente:nom,
    telefono:tel, cedula:ced, direccion:dir, ciudad:ciu, barrio:bar
  });

  jsonp(SCRIPT_URL + "?" + p.toString(), function(err, d) {
    btn.disabled=false; btn.innerHTML="‚ûï &nbsp; Guardar Cliente";
    if (err)          { toast("Error de conexi√≥n","err"); return; }
    if (d.duplicate)  { setErr("err-nom","Ya existe en la base de datos"); return; }
    if (d.error)      { toast("Error: "+d.error,"err"); return; }
    if (!catalogo[ej]) catalogo[ej]=[];
    catalogo[ej].push(nom);
    // Limpiar form
    ["nc-nom","nc-tel","nc-ced","nc-dir","nc-ciu","nc-bar"].forEach(function(id){
      document.getElementById(id).value="";
    });
    document.getElementById("nc-ej").value="";
    toast("‚úÖ Cliente guardado");
    switchTab("visita");
  });
}

function setErr(id, msg) {
  var e = document.getElementById(id); e.textContent=msg; e.className="ferr on";
}

// ‚îÄ‚îÄ Render historial
var pillClass = ["p0","p1","p2","p3","p4","p5"];
var pillMap = {"VENTA":"p0","COBRO":"p1","NO HUBO CONTACTO":"p2","PRIMER CONTACTO":"p3","SEGUNDO CONTACTO":"p4","TERCER CONTACTO":"p5"};

function renderVisitas() {
  var list = document.getElementById("vlist");
  document.getElementById("vcnt").textContent = visitas.length;
  if (!visitas.length) { list.innerHTML="<div class='emptylog'>A√∫n no hay visitas registradas</div>"; return; }
  list.innerHTML = visitas.map(function(v){
    var pc = pillMap[v.res] || "p3";
    return "<div class='vi'>" +
      (v.fotoData ? "<img class='vthumb' src='"+v.fotoData+"' alt=''>" : "<div class='vnothumb'>üè¢</div>") +
      "<div class='vdet'>" +
      "<div class='vclient'>" + v.cl + "</div>" +
      "<div class='vmeta'><span>"+v.ej+"</span><span class='pill "+pc+"'>"+v.res+"</span></div>" +
      "<div class='vmeta' style='margin-top:3px'><span>üïê "+v.fecha+"</span>" +
      "<a href='"+v.mapsUrl+"' target='_blank' style='color:var(--accent);text-decoration:none'>üìç Mapa</a></div>" +
      "</div></div>";
  }).join("");
}

// ‚îÄ‚îÄ Export CSV
function exportCSV() {
  if (!visitas.length) { toast("No hay visitas","err"); return; }
  var rows = [["Fecha","Ejecutivo","Cliente","Resultado","GPS"].join(",")];
  visitas.forEach(function(v){
    rows.push(['"'+v.fecha+'"','"'+v.ej+'"','"'+v.cl+'"','"'+v.res+'"','"'+v.mapsUrl+'"'].join(","));
  });
  var blob = new Blob(["\uFEFF"+rows.join("\n")],{type:"text/csv;charset=utf-8;"});
  var a = document.createElement("a");
  a.href=window.URL.createObjectURL(blob); a.download="visitas_"+new Date().toISOString().slice(0,10)+".csv"; a.click();
  toast("üìä CSV descargado");
}

// ‚îÄ‚îÄ Log
function log(msg) {
  var p = document.getElementById("logpanel");
  p.style.display = "block";
  var t = new Date().toLocaleTimeString("es-CO");
  p.textContent += "[" + t + "] " + msg + "
";
  p.scrollTop = p.scrollHeight;
}

// ‚îÄ‚îÄ Toast
function toast(msg, type) {
  var t = document.getElementById("toast");
  t.textContent = msg;
  t.className = type==="err" ? "err" : (type==="warn" ? "warn" : "");
  requestAnimationFrame(function(){ t.classList.add("show"); });
  setTimeout(function(){ t.classList.remove("show"); }, 3500);
}
</script>
</body>
</html>
