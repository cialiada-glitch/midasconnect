<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#006655">
<title>Midas Connect</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f0f4f2;
    --surface: #ffffff;
    --surface2: #e8f0ed;
    --accent: #006655;
    --accent2: #008a70;
    --accent-light: #e0f0ec;
    --danger: #d63031;
    --warn: #e17055;
    --text: #1a2e28;
    --muted: #5a7a6e;
    --border: #c8ddd8;
    --radius: 16px;
    --font-head: "Syne", sans-serif;
    --font-body: "DM Sans", sans-serif;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: var(--font-body); background: var(--bg); color: var(--text); min-height: 100vh; }
  body::before {
    content: ""; position: fixed; inset: 0;
    background-image: linear-gradient(rgba(0,102,85,0.04) 1px,transparent 1px), linear-gradient(90deg,rgba(0,102,85,0.04) 1px,transparent 1px);
    background-size: 36px 36px; pointer-events: none; z-index: 0;
  }
  .app { position: relative; z-index: 1; max-width: 480px; margin: 0 auto; padding: 20px 16px 100px; }

  /* Header */
  .header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 20px; background: var(--surface);
    border: 1px solid var(--border); border-radius: var(--radius);
    padding: 12px 16px; box-shadow: 0 2px 12px rgba(0,102,85,0.08);
  }
  .header-left { display: flex; flex-direction: column; gap: 2px; }
  .logo-img { height: 40px; object-fit: contain; }
  .app-name { font-family: var(--font-head); font-size: 10px; font-weight: 700; letter-spacing: 2px; color: var(--muted); text-transform: uppercase; margin-top: 2px; }
  .badge { background: var(--surface2); border: 1px solid var(--border); border-radius: 20px; padding: 5px 12px; font-size: 11px; color: var(--muted); font-weight: 500; }
  .badge.live { border-color: var(--accent); color: var(--accent); }
  .badge.live::before { content: "‚óè "; animation: blink 1.2s infinite; }
  @keyframes blink { 0%,100%{opacity:1}50%{opacity:0.3} }

  /* GPS */
  #gps-banner {
    background: var(--surface); border: 1px solid var(--border);
    border-left: 3px solid var(--accent2); border-radius: var(--radius);
    padding: 12px 14px; margin-bottom: 14px;
    display: flex; align-items: center; gap: 10px; transition: all 0.3s;
  }
  #gps-banner.ok { border-left-color: var(--accent); background: #f0faf7; }
  .gps-icon { font-size: 20px; flex-shrink: 0; }
  .gps-info { flex: 1; }
  .gps-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--muted); margin-bottom: 2px; }
  .gps-value { font-size: 11px; font-weight: 600; color: var(--text); word-break: break-all; }
  #gps-btn {
    background: var(--accent); color: #fff; border: none; border-radius: 10px;
    padding: 8px 14px; font-family: var(--font-body); font-size: 12px; font-weight: 600;
    cursor: pointer; white-space: nowrap; transition: opacity 0.2s;
  }
  #gps-btn:hover { opacity: 0.85; }
  #gps-btn:disabled { opacity: 0.4; cursor: not-allowed; }

  /* Cards */
  .card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 18px; margin-bottom: 12px;
    box-shadow: 0 2px 10px rgba(0,102,85,0.06);
  }
  .card-title {
    font-family: var(--font-head); font-size: 11px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 1.5px; color: var(--muted); margin-bottom: 14px;
  }
  .field { margin-bottom: 12px; }
  label { display: block; font-size: 11px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 5px; }
  .required-star { color: var(--danger); }

  input[type="text"], input[type="tel"], input[type="number"], select, textarea {
    width: 100%; background: var(--surface2); border: 1px solid var(--border);
    border-radius: 10px; padding: 11px 13px; color: var(--text);
    font-family: var(--font-body); font-size: 15px; outline: none;
    transition: border-color 0.2s; -webkit-appearance: none;
  }
  input:focus, select:focus, textarea:focus { border-color: var(--accent); background: #f5faf8; }
  input.error-field { border-color: var(--danger); background: #fff5f5; }
  select:disabled { opacity: 0.5; }
  .field-hint { font-size: 10px; color: var(--muted); margin-top: 4px; }
  .field-error { font-size: 11px; color: var(--danger); margin-top: 4px; display: none; font-weight: 500; }
  .field-error.visible { display: block; }

  /* Tabs */
  .tabs { display: flex; gap: 6px; margin-bottom: 14px; }
  .tab-btn {
    flex: 1; padding: 10px; border-radius: 10px; border: 1px solid var(--border);
    background: var(--surface2); color: var(--muted); font-family: var(--font-head);
    font-size: 12px; font-weight: 700; cursor: pointer; transition: all 0.2s;
    text-transform: uppercase; letter-spacing: 0.5px;
  }
  .tab-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
  .tab-panel { display: none; }
  .tab-panel.active { display: block; }

  /* Nuevo cliente */
  .field-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

  /* Photo */
  .photo-zone {
    border: 2px dashed var(--border); border-radius: var(--radius);
    min-height: 150px; display: flex; flex-direction: column;
    align-items: center; justify-content: center; gap: 8px;
    cursor: pointer; transition: all 0.2s; overflow: hidden;
    position: relative; background: var(--surface2);
  }
  .photo-zone:hover { border-color: var(--accent); }
  .photo-zone.has-photo { border-style: solid; border-color: var(--accent); }
  .photo-zone img { width: 100%; height: 170px; object-fit: cover; border-radius: 12px; }
  .photo-overlay { position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.6); border-radius: 8px; padding: 4px 10px; font-size: 11px; color: #fff; }
  .photo-placeholder { display: flex; flex-direction: column; align-items: center; gap: 6px; color: var(--muted); pointer-events: none; }
  .photo-placeholder .icon { font-size: 30px; opacity: 0.5; }
  .photo-placeholder p { font-size: 13px; font-weight: 600; }
  .photo-placeholder span { font-size: 11px; }

  /* Buttons */
  .submit-btn {
    width: 100%; padding: 16px; background: var(--accent); border: none;
    border-radius: var(--radius); color: #fff; font-family: var(--font-head);
    font-size: 16px; font-weight: 700; letter-spacing: 0.5px; cursor: pointer;
    transition: transform 0.15s, box-shadow 0.2s;
    box-shadow: 0 4px 20px rgba(0,102,85,0.3); margin-top: 6px;
  }
  .submit-btn:hover { transform: translateY(-1px); box-shadow: 0 8px 30px rgba(0,102,85,0.4); }
  .submit-btn:active { transform: scale(0.98); }
  .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
  .submit-btn.secondary { background: var(--surface2); color: var(--accent); border: 1px solid var(--accent); box-shadow: none; margin-top: 0; }

  /* Toast */
  #toast {
    position: fixed; bottom: 28px; left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: var(--accent); color: #fff; padding: 13px 22px;
    border-radius: 30px; font-size: 14px; font-weight: 600;
    box-shadow: 0 8px 30px rgba(0,0,0,0.15); transition: transform 0.3s ease;
    white-space: nowrap; z-index: 100;
  }
  #toast.show { transform: translateX(-50%) translateY(0); }
  #toast.error { background: var(--danger); }
  #toast.warn { background: var(--warn); }

  /* Log */
  .section-label {
    font-family: var(--font-head); font-size: 11px; text-transform: uppercase;
    letter-spacing: 2px; color: var(--muted); margin: 22px 0 10px;
    display: flex; align-items: center; gap: 10px;
  }
  .section-label::after { content: ""; flex: 1; height: 1px; background: var(--border); }
  .log-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; box-shadow: 0 2px 10px rgba(0,102,85,0.06); }
  .log-header { display: flex; align-items: center; justify-content: space-between; padding: 14px 18px; border-bottom: 1px solid var(--border); }
  .log-title { font-family: var(--font-head); font-size: 14px; font-weight: 700; }
  .log-count { background: var(--accent); color: #fff; font-size: 11px; font-weight: 800; padding: 3px 9px; border-radius: 20px; }
  .visit-item { padding: 12px 18px; border-bottom: 1px solid var(--border); display: flex; gap: 10px; align-items: flex-start; animation: slideIn 0.3s ease; }
  @keyframes slideIn { from{opacity:0;transform:translateX(-8px)}to{opacity:1;transform:translateX(0)} }
  .visit-item:last-child { border-bottom: none; }
  .visit-thumb { width: 44px; height: 44px; border-radius: 8px; object-fit: cover; flex-shrink: 0; }
  .visit-no-thumb { width: 44px; height: 44px; border-radius: 8px; background: var(--accent-light); display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
  .visit-details { flex: 1; min-width: 0; }
  .visit-client { font-weight: 600; font-size: 14px; margin-bottom: 2px; }
  .visit-meta { font-size: 11px; color: var(--muted); display: flex; gap: 8px; flex-wrap: wrap; }
  .status-pill { display: inline-block; padding: 2px 8px; border-radius: 20px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
  .s-venta{background:#d4f5e9;color:#006644}
  .s-cobro{background:#d4eaf5;color:#005080}
  .s-nocontacto{background:#fde8e8;color:#c0392b}
  .s-primero{background:#fff3cd;color:#856404}
  .s-segundo{background:#ffe0cc;color:#8a3a00}
  .s-tercero{background:#e8d5f5;color:#5a0080}
  .export-btn { margin: 0 18px 16px; width: calc(100% - 36px); padding: 11px; background: transparent; border: 1px solid var(--border); border-radius: 10px; color: var(--muted); font-family: var(--font-body); font-size: 13px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; }
  .export-btn:hover { border-color: var(--accent); color: var(--accent); }
  .empty-log { padding: 28px 18px; text-align: center; color: var(--muted); font-size: 13px; }
  #ejecutivo-status { font-size: 11px; color: var(--muted); margin-top: 5px; display: none; }
</style>
</head>
<body>
<div class="app">

  <div class="header">
    <div class="header-left">
      <img src="data:image/png;base64,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" alt="Tecnolabs" class="logo-img">
      <div class="app-name">Midas Connect</div>
    </div>
    <div class="badge" id="status-badge">GPS Inactivo</div>
  </div>

  <div id="gps-banner">
    <div class="gps-icon">üìç</div>
    <div class="gps-info">
      <div class="gps-label">Ubicaci√≥n actual</div>
      <div class="gps-value" id="gps-text">Sin ubicaci√≥n ‚Äî requerida para registrar</div>
    </div>
    <button id="gps-btn" onclick="captureGPS()">Obtener GPS</button>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('visita')">üìã Registrar Visita</button>
    <button class="tab-btn" onclick="switchTab('cliente')">‚ûï Nuevo Cliente</button>
  </div>

  <!-- TAB: VISITA -->
  <div class="tab-panel active" id="tab-visita">
    <div class="card">
      <div class="card-title">Datos de la Visita</div>

      <div class="field">
        <label>Ejecutivo <span class="required-star">*</span></label>
        <select id="f-ejecutivo" onchange="cargarClientes()">
          <option value="">‚Äî Cargando ejecutivos... ‚Äî</option>
        </select>
        <div id="ejecutivo-status"></div>
      </div>

      <div class="field">
        <label>Cliente <span class="required-star">*</span></label>
        <select id="f-cliente" disabled>
          <option value="">‚Äî Selecciona un ejecutivo primero ‚Äî</option>
        </select>
      </div>

      <div class="field">
        <label>Resultado <span class="required-star">*</span></label>
        <select id="f-resultado" disabled>
          <option value="">‚Äî Cargando resultados... ‚Äî</option>
        </select>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Evidencia Fotogr√°fica</div>
      <div class="photo-zone" id="photo-zone" onclick="openCamera()">
        <input type="file" accept="image/*" capture="environment" id="photo-input" onchange="handlePhoto(event)" style="display:none">
        <div class="photo-placeholder">
          <div class="icon">üì∑</div>
          <p>Tomar foto</p>
          <span>Solo c√°mara del dispositivo</span>
        </div>
      </div>
    </div>

    <button class="submit-btn" onclick="submitVisit()">‚úì &nbsp; Registrar Visita</button>
  </div>

  <!-- TAB: NUEVO CLIENTE -->
  <div class="tab-panel" id="tab-cliente">
    <div class="card">
      <div class="card-title">Crear Nuevo Cliente</div>

      <div class="field">
        <label>Ejecutivo asignado <span class="required-star">*</span></label>
        <select id="nc-ejecutivo">
          <option value="">‚Äî Selecciona ejecutivo ‚Äî</option>
        </select>
      </div>

      <div class="field">
        <label>Nombre del cliente <span class="required-star">*</span></label>
        <input type="text" id="nc-nombre" placeholder="Ej: Farmacia San Jos√©" oninput="sanitizarTexto(this)">
        <div class="field-hint">Solo letras, n√∫meros y espacios</div>
        <div class="field-error" id="err-nombre"></div>
      </div>

      <div class="field-row">
        <div class="field">
          <label>Tel√©fono <span class="required-star">*</span></label>
          <input type="tel" id="nc-telefono" placeholder="3001234567" inputmode="numeric" oninput="soloNumeros(this)">
          <div class="field-error" id="err-telefono"></div>
        </div>
        <div class="field">
          <label>C√©dula / NIT <span class="required-star">*</span></label>
          <input type="tel" id="nc-cedula" placeholder="123456789" inputmode="numeric" oninput="soloNumeros(this)">
          <div class="field-error" id="err-cedula"></div>
        </div>
      </div>

      <div class="field">
        <label>Direcci√≥n <span class="required-star">*</span></label>
        <input type="text" id="nc-direccion" placeholder="Cra 15 No 23 45" oninput="sanitizarDireccion(this)">
        <div class="field-hint">Solo letras, n√∫meros, espacios y puntos</div>
        <div class="field-error" id="err-direccion"></div>
      </div>

      <div class="field-row">
        <div class="field">
          <label>Ciudad <span class="required-star">*</span></label>
          <input type="text" id="nc-ciudad" placeholder="Bogot√°" oninput="sanitizarTexto(this)">
          <div class="field-error" id="err-ciudad"></div>
        </div>
        <div class="field">
          <label>Barrio <span class="required-star">*</span></label>
          <input type="text" id="nc-barrio" placeholder="Chapinero" oninput="sanitizarTexto(this)">
          <div class="field-error" id="err-barrio"></div>
        </div>
      </div>
    </div>

    <button class="submit-btn" onclick="guardarNuevoCliente()">‚ûï &nbsp; Guardar Cliente</button>
  </div>

  <div class="section-label">Visitas registradas hoy</div>
  <div class="log-card">
    <div class="log-header">
      <div class="log-title">Historial</div>
      <div class="log-count" id="visit-count">0</div>
    </div>
    <div id="visits-list"><div class="empty-log">A√∫n no hay visitas registradas</div></div>
    <button class="export-btn" onclick="exportCSV()">‚¨á Exportar CSV</button>
  </div>
</div>

<div id="toast"></div>
<iframe name="hidden_iframe" id="hidden_iframe" style="display:none"></iframe>

<script>
const SHEETS_URL = "https://script.google.com/macros/s/AKfycbzKKEY60FtX9NkpsMC4Ve9k_IA51NiUeWWW1YQ8RHNXG11SIH2Ba3pk5z-26cMm6RBg/exec";
const CATALOG_URL = SHEETS_URL;

let gpsData = null;
let photoBase64 = null;
let catalogData = {};
let visits = JSON.parse(localStorage.getItem("mc_visits") || "[]");

renderVisits();
cargarEjecutivos();
cargarResultados();

// ‚îÄ‚îÄ Tabs
function switchTab(tab) {
  document.querySelectorAll(".tab-btn").forEach((b,i) => b.classList.toggle("active", (i===0&&tab==="visita")||(i===1&&tab==="cliente")));
  document.getElementById("tab-visita").classList.toggle("active", tab==="visita");
  document.getElementById("tab-cliente").classList.toggle("active", tab==="cliente");
}

// ‚îÄ‚îÄ JSONP helper
function jsonp(url, cb) {
  const name = "cb_" + Date.now() + "_" + Math.random().toString(36).slice(2);
  const s = document.createElement("script");
  s.src = url + (url.includes("?")?"&":"?") + "callback=" + name;
  window[name] = function(data) { delete window[name]; document.body.removeChild(s); cb(null, data); };
  s.onerror = function() { delete window[name]; document.body.removeChild(s); cb(new Error("Error de red")); };
  document.body.appendChild(s);
}

// ‚îÄ‚îÄ Cargar ejecutivos
function cargarEjecutivos() {
  const status = document.getElementById("ejecutivo-status");
  status.style.display = "block";
  status.textContent = "‚è≥ Cargando...";

  jsonp(CATALOG_URL + "?action=catalogo", function(err, data) {
    if (err || data.error) { status.textContent = "‚ö†Ô∏è Error cargando ejecutivos"; return; }
    Object.keys(data).forEach(ej => { data[ej] = [...new Set(data[ej])]; });
    catalogData = data;
    const opts = ["<option value=''>‚Äî Selecciona tu nombre ‚Äî</option>"];
    Object.keys(data).sort().forEach(ej => opts.push("<option value='" + ej + "'>" + ej + "</option>"));
    const html = opts.join("");
    document.getElementById("f-ejecutivo").innerHTML = html;
    document.getElementById("nc-ejecutivo").innerHTML = html;
    status.textContent = "‚úì " + Object.keys(data).length + " ejecutivos";
    setTimeout(() => { status.style.display = "none"; }, 2000);
  });
}

// ‚îÄ‚îÄ Cargar resultados
function cargarResultados() {
  jsonp(CATALOG_URL + "?action=resultados", function(err, data) {
    const sel = document.getElementById("f-resultado");
    const fallback = ["VENTA","NO HUBO CONTACTO","COBRO","PRIMER CONTACTO","SEGUNDO CONTACTO","TERCER CONTACTO"];
    const lista = (!err && Array.isArray(data)) ? data : fallback;
    sel.innerHTML = "<option value=''>‚Äî Selecciona ‚Äî</option>" + lista.map(r => "<option value='" + r + "'>" + r + "</option>").join("");
    sel.disabled = false;
  });
}

// ‚îÄ‚îÄ Clientes por ejecutivo
function cargarClientes() {
  const ej = document.getElementById("f-ejecutivo").value;
  const sel = document.getElementById("f-cliente");
  if (!ej) { sel.innerHTML = "<option value=''>‚Äî Selecciona un ejecutivo primero ‚Äî</option>"; sel.disabled = true; return; }
  const clientes = (catalogData[ej] || []).slice().sort();
  sel.innerHTML = "<option value=''>‚Äî Selecciona cliente ‚Äî</option>" + clientes.map(c => "<option value='" + c + "'>" + c + "</option>").join("");
  sel.disabled = false;
}

// ‚îÄ‚îÄ Sanitizaci√≥n
function sanitizarTexto(input) {
  input.value = input.value.replace(/[^a-zA-Z0-9√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë√º√ú\s]/g, "");
}
function sanitizarDireccion(input) {
  input.value = input.value.replace(/[^a-zA-Z0-9√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s\.#]/g, "");
}
function soloNumeros(input) {
  input.value = input.value.replace(/[^0-9]/g, "");
}

function mostrarError(id, msg) {
  const el = document.getElementById(id);
  el.textContent = msg; el.classList.add("visible");
  document.getElementById(id.replace("err-","nc-")).classList.add("error-field");
}
function limpiarErrores() {
  document.querySelectorAll(".field-error").forEach(e => { e.textContent = ""; e.classList.remove("visible"); });
  document.querySelectorAll(".error-field").forEach(e => e.classList.remove("error-field"));
}

// ‚îÄ‚îÄ GPS
function captureGPS() {
  const btn = document.getElementById("gps-btn");
  btn.disabled = true; btn.textContent = "...";
  if (!navigator.geolocation) { showToast("GPS no disponible", true); btn.disabled = false; return; }
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const {latitude, longitude, accuracy} = pos.coords;
      gpsData = {lat: latitude, lon: longitude, acc: Math.round(accuracy)};
      document.getElementById("gps-text").textContent = latitude.toFixed(6) + ", " + longitude.toFixed(6) + " (¬±" + gpsData.acc + "m)";
      document.getElementById("gps-banner").classList.add("ok");
      document.getElementById("status-badge").textContent = "GPS Activo";
      document.getElementById("status-badge").classList.add("live");
      btn.textContent = "‚úì Listo"; btn.style.background = "#008a70";
      showToast("üìç Ubicaci√≥n capturada");
    },
    (err) => {
      const msgs = {1:"Permiso denegado",2:"GPS no disponible",3:"Tiempo agotado"};
      showToast(msgs[err.code] || "Error GPS", true);
      btn.disabled = false; btn.textContent = "Reintentar";
    },
    {enableHighAccuracy: true, timeout: 12000, maximumAge: 0}
  );
}

// ‚îÄ‚îÄ Foto
function openCamera() { document.getElementById("photo-input").click(); }
function handlePhoto(e) {
  const file = e.target.files[0];
  if (!file) return;
  if (file.size > 5*1024*1024) { showToast("Foto muy grande (m√°x 5MB)", true); return; }
  const reader = new FileReader();
  reader.onload = (ev) => {
    photoBase64 = ev.target.result;
    const zone = document.getElementById("photo-zone");
    zone.classList.add("has-photo");
    zone.innerHTML = "<input type='file' accept='image/*' capture='environment' id='photo-input' onchange='handlePhoto(event)' style='display:none'><img src='" + photoBase64 + "' alt='Evidencia' onclick='openCamera()' style='cursor:pointer'><div class='photo-overlay'>üì∑ Cambiar</div>";
  };
  reader.readAsDataURL(file);
}

// ‚îÄ‚îÄ Registrar visita
function submitVisit() {
  const ejecutivo = document.getElementById("f-ejecutivo").value.trim();
  const cliente   = document.getElementById("f-cliente").value.trim();
  const resultado = document.getElementById("f-resultado").value;

  if (!ejecutivo || !cliente || !resultado) { showToast("Completa todos los campos", true); return; }

  // GPS OBLIGATORIO
  if (!gpsData) {
    showToast("‚ö†Ô∏è El GPS es obligatorio para registrar la visita", true);
    document.getElementById("gps-banner").style.animation = "shake 0.4s";
    setTimeout(() => { document.getElementById("gps-banner").style.animation = ""; }, 400);
    return;
  }

  const visit = {
    id: Date.now(),
    fecha: new Date().toLocaleString("es-CO"),
    ejecutivo, cliente, resultado,
    lat: gpsData.lat, lon: gpsData.lon, precision: gpsData.acc,
    mapsUrl: "https://maps.google.com/?q=" + gpsData.lat + "," + gpsData.lon,
    foto: photoBase64 ? "‚úì" : "‚Äî",
    fotoData: photoBase64,
  };

  visits.unshift(visit);
  localStorage.setItem("mc_visits", JSON.stringify(visits));
  renderVisits();

  const btn = document.querySelector("#tab-visita .submit-btn");
  btn.disabled = true; btn.textContent = "Enviando...";

  const payload = {
    id: visit.id, fecha: visit.fecha, ejecutivo, cliente, resultado,
    lat: visit.lat, lon: visit.lon, precision: visit.precision,
    mapsUrl: visit.mapsUrl, fotoBase64: photoBase64 || null,
  };

  const form = document.createElement("form");
  form.method = "POST"; form.action = SHEETS_URL; form.target = "hidden_iframe"; form.style.display = "none";
  const inp = document.createElement("input");
  inp.type = "hidden"; inp.name = "payload"; inp.value = JSON.stringify(payload);
  form.appendChild(inp); document.body.appendChild(form);

  document.getElementById("hidden_iframe").onload = function() {
    resetForm(); showToast("‚úÖ Visita registrada en Sheets");
    btn.disabled = false; btn.innerHTML = "‚úì &nbsp; Registrar Visita";
  };
  form.submit(); document.body.removeChild(form);
  setTimeout(() => {
    if (btn.disabled) { resetForm(); showToast("‚úÖ Visita registrada"); btn.disabled = false; btn.innerHTML = "‚úì &nbsp; Registrar Visita"; }
  }, 3000);
}

// ‚îÄ‚îÄ Guardar nuevo cliente
function guardarNuevoCliente() {
  limpiarErrores();
  const ejecutivo = document.getElementById("nc-ejecutivo").value.trim();
  const nombre    = document.getElementById("nc-nombre").value.trim().toUpperCase();
  const telefono  = document.getElementById("nc-telefono").value.trim();
  const cedula    = document.getElementById("nc-cedula").value.trim();
  const direccion = document.getElementById("nc-direccion").value.trim();
  const ciudad    = document.getElementById("nc-ciudad").value.trim().toUpperCase();
  const barrio    = document.getElementById("nc-barrio").value.trim().toUpperCase();

  let valid = true;
  if (!ejecutivo) { showToast("Selecciona un ejecutivo", true); valid = false; }
  if (!nombre) { mostrarError("err-nombre", "Campo requerido"); valid = false; }
  if (!telefono || telefono.length < 7) { mostrarError("err-telefono", "Tel√©fono inv√°lido"); valid = false; }
  if (!cedula || cedula.length < 6) { mostrarError("err-cedula", "C√©dula/NIT inv√°lido"); valid = false; }
  if (!direccion) { mostrarError("err-direccion", "Campo requerido"); valid = false; }
  if (!ciudad) { mostrarError("err-ciudad", "Campo requerido"); valid = false; }
  if (!barrio) { mostrarError("err-barrio", "Campo requerido"); valid = false; }
  if (!valid) return;

  // Validar duplicado local
  const existentes = catalogData[ejecutivo] || [];
  if (existentes.some(c => c.toUpperCase() === nombre)) {
    mostrarError("err-nombre", "Este cliente ya existe para este ejecutivo");
    return;
  }

  const btn = document.querySelector("#tab-cliente .submit-btn");
  btn.disabled = true; btn.textContent = "Guardando...";

  // Enviar al Sheets via JSONP
  const url = CATALOG_URL + "?action=nuevoCliente" +
    "&ejecutivo=" + encodeURIComponent(ejecutivo) +
    "&cliente="   + encodeURIComponent(nombre) +
    "&telefono="  + encodeURIComponent(telefono) +
    "&cedula="    + encodeURIComponent(cedula) +
    "&direccion=" + encodeURIComponent(direccion) +
    "&ciudad="    + encodeURIComponent(ciudad) +
    "&barrio="    + encodeURIComponent(barrio);

  jsonp(url, function(err, data) {
    btn.disabled = false; btn.innerHTML = "‚ûï &nbsp; Guardar Cliente";
    if (err) { showToast("Error de conexi√≥n", true); return; }
    if (data.duplicate) { mostrarError("err-nombre", "Ya existe en la base de datos"); return; }
    if (data.error) { showToast("Error: " + data.error, true); return; }

    // Agregar localmente al cat√°logo
    if (!catalogData[ejecutivo]) catalogData[ejecutivo] = [];
    catalogData[ejecutivo].push(nombre);

    // Actualizar dropdown de visitas si es el mismo ejecutivo
    if (document.getElementById("f-ejecutivo").value === ejecutivo) {
      cargarClientes();
    }

    // Limpiar form
    ["nc-nombre","nc-telefono","nc-cedula","nc-direccion","nc-ciudad","nc-barrio"].forEach(id => {
      document.getElementById(id).value = "";
    });
    document.getElementById("nc-ejecutivo").value = "";
    limpiarErrores();
    showToast("‚úÖ Cliente guardado correctamente");
    switchTab("visita");
  });
}

// ‚îÄ‚îÄ Render historial
function renderVisits() {
  const list = document.getElementById("visits-list");
  document.getElementById("visit-count").textContent = visits.length;
  if (!visits.length) { list.innerHTML = "<div class='empty-log'>A√∫n no hay visitas registradas</div>"; return; }
  const pill = {"VENTA":"s-venta","COBRO":"s-cobro","NO HUBO CONTACTO":"s-nocontacto","PRIMER CONTACTO":"s-primero","SEGUNDO CONTACTO":"s-segundo","TERCER CONTACTO":"s-tercero"};
  list.innerHTML = visits.map(v =>
    "<div class='visit-item'>" +
    (v.fotoData ? "<img class='visit-thumb' src='" + v.fotoData + "' alt=''>" : "<div class='visit-no-thumb'>üè¢</div>") +
    "<div class='visit-details'>" +
    "<div class='visit-client'>" + v.cliente + "</div>" +
    "<div class='visit-meta'><span>" + v.ejecutivo + "</span>" +
    "<span class='status-pill " + (pill[v.resultado]||"s-primero") + "'>" + v.resultado + "</span></div>" +
    "<div class='visit-meta' style='margin-top:3px'><span>üïê " + v.fecha + "</span>" +
    "<a href='" + v.mapsUrl + "' target='_blank' style='color:var(--accent);text-decoration:none'>üìç Mapa</a></div>" +
    "</div></div>"
  ).join("");
}

// ‚îÄ‚îÄ Reset visita
function resetForm() {
  gpsData = null; photoBase64 = null;
  document.getElementById("f-cliente").value = "";
  document.getElementById("f-resultado").value = "";
  document.getElementById("f-ejecutivo").value = "";
  document.getElementById("f-cliente").disabled = true;
  document.getElementById("f-cliente").innerHTML = "<option value=''>‚Äî Selecciona un ejecutivo primero ‚Äî</option>";
  document.getElementById("gps-text").textContent = "Sin ubicaci√≥n ‚Äî requerida para registrar";
  document.getElementById("gps-banner").classList.remove("ok");
  document.getElementById("status-badge").textContent = "GPS Inactivo";
  document.getElementById("status-badge").classList.remove("live");
  const btn = document.getElementById("gps-btn");
  btn.disabled = false; btn.textContent = "Obtener GPS"; btn.style.background = "";
  const zone = document.getElementById("photo-zone");
  zone.classList.remove("has-photo");
  zone.innerHTML = "<input type='file' accept='image/*' capture='environment' id='photo-input' onchange='handlePhoto(event)' style='display:none'><div class='photo-placeholder'><div class='icon'>üì∑</div><p>Tomar foto</p><span>Solo c√°mara del dispositivo</span></div>";
}

// ‚îÄ‚îÄ Export CSV
function exportCSV() {
  if (!visits.length) { showToast("No hay visitas para exportar", true); return; }
  const headers = ["Fecha","Ejecutivo","Cliente","Resultado","Latitud","Longitud","Google Maps","Foto"];
  const rows = visits.map(v => ['"'+v.fecha+'"','"'+v.ejecutivo+'"','"'+v.cliente+'"','"'+v.resultado+'"',v.lat,v.lon,'"'+v.mapsUrl+'"',v.foto]);
  const csv = [headers.join(","), ...rows.map(r => r.join(","))].join("\n");
  const blob = new Blob(["\uFEFF"+csv], {type:"text/csv;charset=utf-8;"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob); a.download = "visitas_"+new Date().toISOString().slice(0,10)+".csv"; a.click();
  showToast("üìä CSV descargado");
}

// ‚îÄ‚îÄ Toast
function showToast(msg, type) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.className = type===true?"error":(type==="warn"?"warn":"");
  requestAnimationFrame(() => t.classList.add("show"));
  setTimeout(() => t.classList.remove("show"), 3500);
}
</script>
</body>
</html>
